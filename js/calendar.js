// Days off
// let daysOff = [
//   {
//     id: 0,
//     color: '#f2c94c',
//     name: 'Cameron Williamson',
//     periods: [
//       {
//         start: '2021-06-28',
//         end: '2021-07-06',
//       },
//       {
//         start: '2021-08-09',
//         end: '2021-08-18',
//       },
//       {
//         start: '2021-09-23',
//         end: '2021-09-29',
//       },
//     ],
//   },
//   {
//     id: 1,
//     color: '#F78F1E',
//     name: 'Ronald Richards',
//     periods: [
//       {
//         start: '2021-09-27',
//         end: '2021-10-01',
//       },
//     ],
//   },
//   {
//     id: 2,
//     color: '#56ccf2',
//     name: 'Jacob Jones',
//     periods: [
//       {
//         start: '2021-07-19',
//         end: '2021-07-23',
//       },
//     ],
//   },
//   {
//     id: 3,
//     color: '#bb6bd9',
//     name: 'Bessie Cooper',
//     periods: [
//       {
//         start: '2021-11-14',
//         end: '2021-11-20',
//       },
//     ],
//   },
//   {
//     id: 4,
//     color: '#6fcf97',
//     name: 'Devon Lane',
//     periods: [
//       {
//         start: '2021-09-01',
//         end: '2021-09-13',
//       },
//     ],
//   },
// ];

let daysOff = {
  Data: [
    {
      EmployeeId: '97005000',
      EmployeeName: 'Denise Flanders',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-07-15T00:00:00',
      AbsenceFinishDate: '2021-07-22T00:00:00',
      AbsenceDescription: 'Annual Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 6.0,
      AbsenceRequestedHours: 46.8,
      AbsenceState: 'Submitted',
      AbsenceLabelColor: '2CA4BF',
      AbsenceTextColor: 'ffffff',
    },
    {
      EmployeeId: '97005035',
      EmployeeName: 'Christina Hunter',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-01-05T00:00:00',
      AbsenceFinishDate: '2021-01-13T00:00:00',
      AbsenceDescription: 'Annual Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 7.0,
      AbsenceRequestedHours: 54.6,
      AbsenceState: 'Approved',
      AbsenceLabelColor: '8CD19D',
      AbsenceTextColor: 'ffffff',
    },
    {
      EmployeeId: '97005035',
      EmployeeName: 'Christina Hunter',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-07-20T00:00:00',
      AbsenceFinishDate: '2021-07-22T00:00:00',
      AbsenceDescription: 'Annual Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 3.0,
      AbsenceRequestedHours: 23.4,
      AbsenceState: 'Submitted',
      AbsenceLabelColor: '8CD19D',
      AbsenceTextColor: 'ffffff',
    },
    {
      EmployeeId: '97005035',
      EmployeeName: 'Christina Hunter',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-04-14T00:00:00',
      AbsenceFinishDate: '2021-04-15T00:00:00',
      AbsenceDescription: 'Annual Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 2.0,
      AbsenceRequestedHours: 15.6,
      AbsenceState: 'Approved',
      AbsenceLabelColor: '8CD19D',
      AbsenceTextColor: 'ffffff',
    },
    {
      EmployeeId: '97005039',
      EmployeeName: 'Richard Hynes',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-01-04T00:00:00',
      AbsenceFinishDate: '2021-01-08T00:00:00',
      AbsenceDescription: 'Annual Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 5.0,
      AbsenceRequestedHours: 39.0,
      AbsenceState: 'Approved',
      AbsenceLabelColor: '89bdd3',
      AbsenceTextColor: 'ffffff',
    },
    {
      EmployeeId: '97005069',
      EmployeeName: 'John Dowling',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-07-19T00:00:00',
      AbsenceFinishDate: '2021-07-19T00:00:00',
      AbsenceDescription: 'Absent Paid Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 1.0,
      AbsenceRequestedHours: 7.8,
      AbsenceState: 'Approved',
      AbsenceLabelColor: 'e05038',
      AbsenceTextColor: 'ffffff',
    },
    {
      EmployeeId: '97005069',
      EmployeeName: 'John Dowling',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-01-04T00:00:00',
      AbsenceFinishDate: '2021-01-08T00:00:00',
      AbsenceDescription: 'Annual Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 5.0,
      AbsenceRequestedHours: 39.0,
      AbsenceState: 'Approved',
      AbsenceLabelColor: 'e05038',
      AbsenceTextColor: 'ffffff',
    },
    {
      EmployeeId: '97005069',
      EmployeeName: 'John Dowling',
      AbsenceTypeId: null,
      AbsenceStartDate: '2021-01-04T00:00:00',
      AbsenceFinishDate: '2021-01-04T00:00:00',
      AbsenceDescription: 'Annual Leave',
      AbsenceHalfStartDay: false,
      AbsenceHalfFinishDay: false,
      AbsenceRequestedDays: 1.0,
      AbsenceRequestedHours: 7.8,
      AbsenceState: 'Approved',
      AbsenceLabelColor: 'e05038',
      AbsenceTextColor: 'ffffff',
    },
  ],
  AbsenceCalendarShiftType: '4',
  AbsenceRequestedDaysOrHours: 'Days',
  AbsenceDataCutOffYear: 2016,
  AbsenceCalendarFilter: [
    {
      Text: 'Denise Flanders',
      Value: 'EmployeeId_97005000',
      LabelColor: '2CA4BF',
      TextColor: 'ffffff',
      Id: 'AbsenceType_EmployeeId_97005000',
    },
    {
      Text: 'Christina Hunter',
      Value: 'EmployeeId_97005035',
      LabelColor: '8CD19D',
      TextColor: 'ffffff',
      Id: 'AbsenceType_EmployeeId_97005035',
    },
    {
      Text: 'Richard Hynes',
      Value: 'EmployeeId_97005039',
      LabelColor: '89bdd3',
      TextColor: 'ffffff',
      Id: 'AbsenceType_EmployeeId_97005039',
    },
    {
      Text: 'John Dowling',
      Value: 'EmployeeId_97005069',
      LabelColor: 'e05038',
      TextColor: 'ffffff',
      Id: 'AbsenceType_EmployeeId_97005069',
    },
  ],
  CalendarNationalHolidays: [
    '2021-01-01T00:00:00',
    '2021-03-17T00:00:00',
    '2021-04-05T00:00:00',
    '2021-05-03T00:00:00',
    '2021-06-07T00:00:00',
    '2021-08-02T00:00:00',
    '2021-10-25T00:00:00',
    '2021-12-27T00:00:00',
    '2021-12-28T00:00:00',
    '2022-01-03T00:00:00',
    '2022-03-17T00:00:00',
    '2022-04-18T00:00:00',
    '2022-05-02T00:00:00',
    '2022-06-06T00:00:00',
    '2022-08-01T00:00:00',
    '2022-10-31T00:00:00',
    '2022-12-26T00:00:00',
    '2022-12-27T00:00:00',
  ],
  IsThereOverlappingAbsence: true,
  ErrorMessage: null,
};

let calendarArea = document.querySelector('#calendar');
let calendarCode = '';
let monthsQuantitySelector = document.querySelector(
  'select#monthsQuantitySelector'
);
let monthsQuantity = parseInt(monthsQuantitySelector.value);
let startDate = new Date();
startDate.setMonth(0);
startDate.setDate(1);
let endMonthTitle = '';
let endYear = '';
let endDate;
let startMonth, startYear;

const Days = new Array('S', 'M', 'T', 'W', 'T', 'F', 'S');

// Check how many days in a month
function daysInMonth(iMonth, iYear) {
  return new Date(iYear, iMonth + 1, 0).getDate();
}

// Show year
function showYearTitle() {
  calendarCode += `<div class="calendar-header">
    <div class="prev" id="prevBtnCalendar"></div>
    <div id="year-title" class="year-title" colspan="7"></div>
    <div class="next" id="nextBtnCalendar"></div>
  </div>`;
}

// Add year and month title
function addYearMonthsTitle() {
  let titlePlace = document.querySelector('#year-title');
  let year = startDate.getFullYear();
  let startMonthTitle = startDate
    .toLocaleString('en-us', { month: 'short' })
    .toLowerCase();
  titlePlace.innerHTML = `${startMonthTitle} ${year} - ${endMonthTitle} ${endYear}`;
}

// Build days in month table
function showDaysInMonth(month, year) {
  let date = 1;
  let _day, _month;
  let firstDay = new Date(year, month).getDay();

  for (let i = 0; i < 6; i++) {
    calendarCode += '<tr>';

    for (let j = 0; j < 7; j++) {
      if (i === 0 && j < firstDay) {
        calendarCode += '<td></td>';
      } else if (date > daysInMonth(month, year)) {
      } else {
        _day = date < 10 ? '0' + date : date;
        _month = month;
        _month = _month + 1;
        _month = _month < 10 ? '0' + _month : _month;
        calendarCode += `<td class="day" id="d-${year}-${_month}-${_day}">${date}</td>`;
        date++;
      }
    }

    calendarCode += '</tr>';
  }
}

// Build one month
function createCalendar() {
  let month;
  let shownYear;
  let date = new Date(startDate);
  let monthLongName;

  startMonth = startDate.getMonth();
  startYear = startDate.getFullYear();

  calendarCode = '';

  showYearTitle();

  calendarCode += '<div class="months-container">';

  for (let i = 0; i < monthsQuantity; i++) {
    month = date.getMonth();
    shownYear = date.getFullYear();
    monthLongName = date.toLocaleString('en-us', { month: 'long' });
    calendarCode += `<table class="month">
  <thead>
  <tr><th class="month-title" colspan="7">${monthLongName}</th></tr><tr>`;

    Days.forEach(
      (item) => (calendarCode += `<th class="day-header">${item}</th>`)
    );

    calendarCode += `</tr></thead><tbody>`;

    showDaysInMonth(month, shownYear);

    calendarCode += `</tbody></tr></table>`;
    if (i < monthsQuantity - 1) date.setMonth(date.getMonth() + 1);
  }

  endMonthTitle = date
    .toLocaleString('en-us', { month: 'short' })
    .toLowerCase();
  endYear = date.getFullYear();

  endDate = new Date(endYear, date.getMonth() + 1, 0);
  endDate.setHours(23, 59, 59, 999);

  //console.log(endDate);

  calendarCode += '</div>';
  calendarArea.innerHTML = calendarCode;
}

createCalendar();
addYearMonthsTitle();
addMonthsHandler();

// Select months quantity
$('#monthsQuantitySelector').on('change', (e) => {
  monthsQuantity = parseInt(e.target.value);
  // Set start depends on select
  if (monthsQuantity != 12) {
    startDate = new Date();
    startDate.setDate(1);
  } else {
    startDate = new Date();
    startDate.setMonth(0);
    startDate.setDate(1);
  }
  createCalendar();
  addYearMonthsTitle();
  addMonthsHandler();
  showDaysOff();
});

// Show prev and next months
function addMonthsHandler() {
  $('.calendar-header').on('click', '.prev', function () {
    startDate.setMonth(startDate.getMonth() - monthsQuantity);
    createCalendar();
    addYearMonthsTitle();
    addMonthsHandler();
    showDaysOff();
  });

  $('.calendar-header').on('click', '.next', function () {
    startDate.setMonth(startDate.getMonth() + monthsQuantity);
    createCalendar();
    addYearMonthsTitle();
    addMonthsHandler();
    showDaysOff();
  });
}

// Checkbox filters
let calendarFilter = document.querySelector('#calendarFilter');
let filtersCode = '';
let cssCheckboxesColors = '';

function addCheckbox(name, color, id) {
  filtersCode += `<label class="mycheckbox-2 bgcolor-${id}">
      <input id="employee-${id}" type="checkbox" checked>
      <span>${name}</span>
    </label>`;

  calendarFilter.innerHTML = filtersCode;

  cssCheckboxesColors += `
    .calendars-checkbox .mycheckbox-2.bgcolor-${id} input:checked + span::before{
      background-color: #${color};
    }

    .calendars-checkbox .mycheckbox-2.bgcolor-${id} span::before{
      border-color: #${color};
    }`;
}

// Filter handlers
function filterHandlers() {
  let checkboxFilters = document.querySelectorAll('#calendarFilter input');

  document.addEventListener(
    'DOMContentLoaded',
    function () {
      for (let checkbox of checkboxFilters) {
        checkbox.addEventListener('change', function () {
          cleanData();
          showDaysOff();
        });
      }
    },
    false
  );
}

// Clean data
function cleanData() {
  let dataDays = document.querySelectorAll('#calendar .day');
  for (let dayItem of dataDays) {
    dayItem.classList.remove('day-first');
    dayItem.classList.remove('day-last');
    dayItem.classList.remove('day-multi');
    dayItem.removeAttribute('style');
  }
}

// Show days off
function showDaysOff() {
  let startOffDate,
    endOffDate,
    isStartInPeriod,
    isEndInPeriod,
    id,
    color,
    employeeId = 0,
    _day,
    _month,
    isFirstDay,
    isLastDay;
  filtersCode = '';
  cssCheckboxesColors = '';

  let _startDate = new Date(startDate);
  _startDate.setHours(0, 0, 0, 0);
  daysOff.Data.forEach((item) => {
    let checkbox = document.querySelector(
      `#calendarFilter #employee-${item.EmployeeId}`
    );
    if (!checkbox) {
      addCheckbox(item.EmployeeName, item.AbsenceLabelColor, item.EmployeeId);
    }

    // Check if employee checkbox is checked
    let employeeCheckboxId = `#employee-${item.EmployeeId}`;

    if ($(employeeCheckboxId)[0].checked) {
      isFirstDay = false;
      isLastDay = false;
      if (employeeId != item.EmployeeId) {
        employeeId = item.EmployeeId;
      }
      color = item.AbsenceLabelColor;
      isStartInPeriod = false;
      isEndInPeriod = false;
      startOffDate = new Date(item.AbsenceStartDate.slice(0, 10));
      startOffDate.setHours(0, 0, 0, 0);
      endOffDate = new Date(item.AbsenceFinishDate.slice(0, 10));
      endOffDate.setHours(23, 59, 59, 999);

      if (startOffDate >= _startDate && startOffDate <= endDate) {
        isStartInPeriod = true;
        isFirstDay = true;
      }

      if (endOffDate >= _startDate && endOffDate <= endDate) {
        isEndInPeriod = true;
        isLastDay = true;
      }

      if (isStartInPeriod && !isEndInPeriod) {
        endOffDate = new Date(endDate);
        isEndInPeriod = true;
      }

      if (!isStartInPeriod && isEndInPeriod) {
        startOffDate = new Date(_startDate);
        isStartInPeriod = true;
      }

      if (isStartInPeriod && isEndInPeriod) {
        for (
          let day = new Date(startOffDate);
          day <= endOffDate;
          day.setDate(day.getDate() + 1)
        ) {
          _day = day.getDate() < 10 ? '0' + day.getDate() : day.getDate();
          _month = day.getMonth();
          _month = _month + 1;
          _month = _month < 10 ? '0' + _month : _month;
          id = `d-${day.getFullYear()}-${_month}-${_day}`;

          if (document.getElementById(id).style.backgroundColor) {
            document.getElementById(id).style = '';
            document.getElementById(id).classList.add('day-multi');
          } else
            document.getElementById(id).style.backgroundColor = `#${color}`;

          // Add styles for first and last day of period
          if (
            _day == startOffDate.getDate() &&
            isFirstDay &&
            _day == endOffDate.getDate() &&
            isLastDay
          ) {
            console.log(id);
            document.getElementById(id).classList.add('day-first');
            document.getElementById(id).classList.add('day-last');
          } else if (_day == startOffDate.getDate() && isFirstDay) {
            document.getElementById(id).classList.add('day-first');
          } else if (_day == endOffDate.getDate() && isLastDay) {
            document.getElementById(id).classList.add('day-last');
          }
        }
      }
    }
  });

  let style = document.createElement('style');
  style.innerHTML = cssCheckboxesColors;
  document.head.appendChild(style);

  filterHandlers();
}

showDaysOff();

// Hover handler
function hoverHandler() {
  let dataDays = document.querySelectorAll('#calendar .day');

  for (let dayItem of dataDays) {
    dayItem.addEventListener('mouseenter', (e) => {
      if (
        e.target.classList.contains('day-multi') ||
        e.target.style.backgroundColor != ''
      )
        showTooltip(e.target);
    });

    dayItem.addEventListener('mouseleave', (e) => {
      if (
        e.target.classList.contains('day-multi') ||
        e.target.style.backgroundColor != ''
      ) {
        let tooltip = document.querySelectorAll(`#${e.target.id} .day-tooltip`);
        document.getElementById(`${e.target.id}`).removeChild(tooltip[0]);
      }
    });
  }
}

function showTooltip(el) {
  let tooltip = document.createElement('div');
  tooltip.className = 'day-tooltip';
  tooltip.innerHTML = el.id;
  el.append(tooltip);
}

hoverHandler();
